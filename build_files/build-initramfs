#!/bin/bash

set -ouex pipefail

# Container builds often run on filesystems that reject xattrs in the initramfs tree.
# They are optional for this image build; disable to avoid noisy/non-fatal failures.
export DRACUT_NO_XATTR="${DRACUT_NO_XATTR:-1}"

# Build initramfs for the newest kernel in /usr/lib/modules.
KERNEL_VERSION="$(basename "$(find /usr/lib/modules -maxdepth 1 -mindepth 1 -type d | sort | tail -n 1)")"

if [ -z "${KERNEL_VERSION}" ]; then
  echo "No kernel found under /usr/lib/modules; cannot generate initramfs" >&2
  exit 1
fi

dracut_args=(--force --no-hostonly --reproducible --zstd --verbose)
if [ -d /usr/lib/dracut/modules.d/95etc-overlay ] || [ -d /usr/lib/dracut/modules.d/90etc-overlay ]; then
  dracut_args+=(--add etc-overlay)
fi

dracut "${dracut_args[@]}" --kver "${KERNEL_VERSION}" "/usr/lib/modules/${KERNEL_VERSION}/initramfs.img"

if [ -f "/boot/vmlinuz-${KERNEL_VERSION}" ]; then
  cp -f "/boot/vmlinuz-${KERNEL_VERSION}" "/usr/lib/modules/${KERNEL_VERSION}/vmlinuz"
fi

rm -f /*.old || true
