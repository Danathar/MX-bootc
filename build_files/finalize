#!/bin/bash

set -ouex pipefail

# Prepare mutable mountpoints expected by bootc.
rm -rf /boot /home /root /srv
mkdir /boot /home /root /srv

# Ensure ostree sysroot layout exists.
mkdir -p /sysroot/ostree/bootc/storage
if [ ! -e /ostree ]; then
  ln -s sysroot/ostree /ostree
fi

# bootc-image-builder invokes `bootc install` which initializes a container
# image store under /var/lib/containers. Ensure baseline paths exist.
mkdir -p /var/lib/containers/storage
mkdir -p /var/lib/containers/storage/runroot

# Provide a basic storage.conf if none exists.
if [ ! -f /etc/containers/storage.conf ]; then
  mkdir -p /etc/containers
  cat > /etc/containers/storage.conf <<'EOF'
[storage]
driver = "overlay"
runroot = "/var/lib/containers/storage/runroot"
graphroot = "/var/lib/containers/storage"
EOF
fi

# Force first-boot identity and ssh host key generation.
rm -f /etc/machine-id
rm -f /etc/ssh/ssh_host_*

# Avoid shipping both /etc and /usr/etc in the final tree.
# bootc deployment aborts if both are present in the committed image.
if [ -d /usr/etc ]; then
  mkdir -p /etc
  cp -a /usr/etc/. /etc/
  rm -rf /usr/etc
fi
